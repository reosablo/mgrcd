var ke=Object.defineProperty,Pe=Object.defineProperties;var _e=Object.getOwnPropertyDescriptors;var ae=Object.getOwnPropertySymbols;var Ne=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var ce=(n,e,t)=>e in n?ke(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,M=(n,e)=>{for(var t in e||(e={}))Ne.call(e,t)&&ce(n,t,e[t]);if(ae)for(var t of ae(e))be.call(e,t)&&ce(n,t,e[t]);return n},$=(n,e)=>Pe(n,_e(e));import{h as Fe,a as N,r as y,u as R,b as U,j as I,B as k,c as s,A as X,T as b,I as De,d as Ce,e as le,S as de,f as Te,g as Ae,i as Le,k as Re,l as Be,m as Oe,n as q,L as B,o as Y,p as V,q as O,s as E,F as ue,t as j,v as fe,w as Q,x as H,C as me,y as Ee,z as je,D as He,E as We,G as Ge,H as Ue,J as Z,K as qe,M as Ve,N as Je,O as ze,P as he,Q as Ke,R as Xe,U as pe,V as Ye,W as Qe,X as Ze,Y as et,Z as tt,_ as nt,$ as ot,a0 as it,a1 as F,a2 as rt,a3 as st}from"./vendor.a63c22a0.js";const at=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}};at();async function*ct(n){var t,o;const e=await["image_native","mini","image"].reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const a=(o=(t=i.match(/^mini_(?<id>\d{6})_d\.png$/))==null?void 0:t.groups)==null?void 0:o.id;a!==void 0&&r instanceof FileSystemFileHandle&&(yield[+a,r])}}async function*lt(n){var t,o;const e=await["image_native","live2d_v4"].reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const a=(o=(t=i.match(/^(?<id>\d{6})$/))==null?void 0:t.groups)==null?void 0:o.id;a!==void 0&&r instanceof FileSystemDirectoryHandle&&(yield[+a,r])}}async function dt(n){return await n.getFileHandle("model.model3.json")}async function ye(n){return await n.getFileHandle("params.json")}async function ut(n,e){return await n.getFileHandle(`model-${e}.model3.json`,{create:!0}).then(t=>t.createWritable())}async function ft(n){return await n.getFile().then(e=>e.text()).then(e=>JSON.parse(e))}async function mt(n,e){const t=JSON.stringify(e,null,"	");await n.write(t)}async function ge(n){return await n.getFile().then(e=>e.text()).then(e=>{try{return JSON.parse(e)}catch{return Fe.parse(e)}})}async function*ht(n){var t,o;const e=await["scenario","json","general"].reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const a=(o=(t=i.match(/^(?<id>\d{6})\.json$/))==null?void 0:t.groups)==null?void 0:o.id;a!==void 0&&r instanceof FileSystemFileHandle&&(yield[+a,r])}}async function*pt(n){var t,o;const e=await["scenario","json","charaOneShot"].reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const a=(o=(t=i.match(/^(?<id>\d{6})\.json$/))==null?void 0:t.groups)==null?void 0:o.id;a!==void 0&&r instanceof FileSystemFileHandle&&(yield[+a,r])}}async function xe(n){return await n.getFile().then(e=>e.text()).then(e=>JSON.parse(e))}async function*yt(n){var t,o;const e=new Set;for(const i of Object.values((t=n.story)!=null?t:{}))for(const r of i)for(const a of(o=r.chara)!=null?o:[]){const c=a.id;e.has(c)||(yield c,e.add(c))}}function gt(n,e,t,o,i){var r;for(const[a,c]of e.entries()){const u=i.getMotionIndex("scene",t,a),[l,f]=u,p=a+1<e.length?i.getMotionIndex("scene",t,a+1).join(":"):void 0,h=c.autoTurnFirst!==void 0?c.autoTurnFirst*1e3:c.autoTurnLast!==void 0?c.autoTurnLast*1e3:void 0,d=(r=c.chara)!=null?r:[],x=wt(o,d,i),g=$t(o,d,i);Mt(n,o,d,i),D(n,l,{Name:f,MotionDuration:h,Command:x,Text:g,NextMtn:p})}}function J([n,e]){return e!==void 0?`${n}:${e}`:n}function ee(n,[e,t]){var o,i;return t!==void 0&&!!((i=(o=n.FileReferences.Motions)==null?void 0:o[e])==null?void 0:i.some(r=>r.Name===t))}function xt(n,e){var t;return!!((t=n.FileReferences.Expressions)==null?void 0:t.some(o=>o.Name===e))}function D(n,e,t){var r,a,c,u;const o=(u=(c=(a=(r=n.FileReferences).Motions)!=null?a:r.Motions={})[e])!=null?u:c[e]=[],i=t.Name;if(i===void 0)o.push(t);else{const l=o.findIndex(f=>f.Name===i);l>=0?o.splice(l,1,t):o.push(t)}}function It(n,e){var r,a;const t=(a=(r=n.FileReferences).Expressions)!=null?a:r.Expressions=[],o=e.Name,i=t.findIndex(c=>c.Name!==o);i>=0?t.splice(i,1,e):t.push(e)}function vt(n,e){var o;const t=(o=n.Options)!=null?o:n.Options={};t.Name=e.charaName,t.ScaleFactor=e.modelScale}function St(n,e,t,o){const i=J(t),r=[`start_mtn ${i}`];for(const a of e!=null?e:[])a===n||a===void 0||r.push(`start_mtn ${o.getModelId(a)} ${i}`);return r.join(";")}function Mt(n,e,t,o){for(const i of t){if(o.getRoleId(i.id)!==e)continue;const{motion:r,face:a,voice:c}=i;if(r!==void 0){const u=o.getMotionIndex("motion",e,r);if(!ee(n,u)){const[l,f]=u,p=o.getFilePath("motion",e,r);r<100?D(n,l,{Name:f,File:p,FileLoop:!0,Command:"eye_blink enforce",FadeOut:0}):D(n,l,{Name:f,Command:"eye_blink enforce",File:p})}}if(a!==void 0){const u=o.getMotionIndex("face",e,a),l=o.getExpressionName("face",e,a);if(!ee(n,u)){const[f,p]=u;D(n,f,{Name:p,Expression:l})}if(!xt(n,l)){const f=o.getFilePath("face",e,a);It(n,{Name:l,File:f})}}if(c!==void 0){const u=o.getMotionIndex("voice",e,c);if(!ee(n,u)){const[l,f]=u,p=o.getFilePath("voice",e,c);D(n,l,{Name:f,Sound:p})}}}}function wt(n,e,t){const o=["parameters unlock"];for(const i of e){if(t.getRoleId(i.id)!==n)continue;const{motion:r,face:a,voice:c,lipSynch:u,cheek:l,eyeClose:f,mouthOpen:p,soulGem:h,tear:d,live2dParam:x,textHomeStatus:g}=i;if(r!==void 0){const m=t.getMotionIndex("motion",n,r);o.push(`start_mtn ${J(m)}`)}if(a!==void 0){const m=t.getMotionIndex("face",n,a);o.push(`start_mtn ${J(m)}`)}if(c!==void 0){const m=t.getMotionIndex("voice",n,c);o.push(`start_mtn ${J(m)}`)}if(u!==void 0&&(u?o.push("unmute_sound 0","lip_sync enable"):e.some(m=>m.lipSynch)?o.push("mute_sound 0"):o.push("lip_sync disable","parameters lock ParamMouthOpenY 0")),l!==void 0&&o.push(`parameters lock ParamCheek ${l}`),f!==void 0&&o.push(`parameters lock ParamEyeLOpen ${1-f}`,`parameters lock ParamEyeROpen ${1-f}`),p!==void 0&&o.push(`parameters lock ParamMouthOpenY ${p}`),h!==void 0&&o.push(`parameters lock ParamSoulgem ${h}`),d!==void 0&&o.push(`parameters lock ParamTear ${d}`),(x==null?void 0:x.name)!==void 0&&(x==null?void 0:x.value)!==void 0){const m=x.name.replace(/_?([A-Za-z]+)/g,(P,S)=>`${S[0].toUpperCase()}${S.slice(1).toLowerCase()}`);o.push(`parameters lock ${m} ${x.value}`)}g==="Clear"&&o.push("hide_text")}return o.join(";")||void 0}function $t(n,e,t){const o=[];for(const i of e){if(t.getRoleId(i.id)!==n)continue;const{textHome:r}=i;if(r!==void 0){const a=r.replace(/\[.*?\]/g,"").replace(/@/g,`
`);o.push(a)}}return o.join("{$br}")||void 0}const v=Symbol("metaKey"),Ie=[["Start",{Name:"Intro1",Priority:9,Intimacy:{Max:0},[v]:{voiceSuffix:"_01",spoiler:!1}}],["Start",{Name:"Intro2",Priority:9,Intimacy:{Max:0},[v]:{voiceSuffix:"_02",spoiler:!1}}],["Start",{Name:"GreetFirst",Priority:9,Intimacy:{Min:1,Bonus:4},[v]:{voiceSuffix:"_24",spoiler:!1}}],["Tap",{Name:"Talk1",Priority:9,Intimacy:{Bonus:1},[v]:{voiceSuffix:"_33",spoiler:!1}}],["Tap",{Name:"Talk2",Priority:9,Intimacy:{Bonus:1},[v]:{voiceSuffix:"_34",spoiler:!1}}],["Tap",{Name:"Talk3",Priority:9,Intimacy:{Bonus:1},[v]:{voiceSuffix:"_35",spoiler:!1}}],["Tap",{Name:"Talk4",Priority:9,Intimacy:{Bonus:1},[v]:{voiceSuffix:"_36",spoiler:!1}}],["Tap",{Name:"Talk5",Priority:9,Intimacy:{Min:8,Bonus:1},[v]:{voiceSuffix:"_37",spoiler:!1}}],["Tap",{Name:"Talk6",Priority:9,Intimacy:{Min:16,Bonus:1},[v]:{voiceSuffix:"_38",spoiler:!1}}],["Tap",{Name:"Talk7",Priority:9,Intimacy:{Min:24,Bonus:1},[v]:{voiceSuffix:"_39",spoiler:!1}}],["Tap",{Name:"Talk8",Priority:9,Intimacy:{Min:32,Bonus:1},[v]:{voiceSuffix:"_40",spoiler:!1}}],["Tap",{Name:"Talk9",Priority:9,Intimacy:{Min:40,Bonus:1},[v]:{voiceSuffix:"_41",spoiler:!1}}],["Tap",{Name:"Talk10",Priority:9,Intimacy:{Min:48,Bonus:1},[v]:{voiceSuffix:"_32",spoiler:!0}}],["Tap",{Name:"GreetMorning",Priority:9,Weight:2,TimeLimit:{Hour:6,Sustain:180},Intimacy:{Bonus:1},[v]:{voiceSuffix:"_25",spoiler:!1}}],["Tap",{Name:"GreetDay",Priority:9,Weight:2,TimeLimit:{Hour:11,Sustain:120},Intimacy:{Bonus:1},[v]:{voiceSuffix:"_26",spoiler:!1}}],["Tap",{Name:"GreetEvening",Priority:9,Weight:2,TimeLimit:{Hour:17,Sustain:120},Intimacy:{Bonus:1},[v]:{voiceSuffix:"_27",spoiler:!1}}],["Tap",{Name:"GreetNight",Priority:9,Weight:2,TimeLimit:{Hour:22,Sustain:120},Intimacy:{Bonus:1},[v]:{voiceSuffix:"_28",spoiler:!1}}],["Tap",{Name:"Greet",Priority:9,ignorable:!0,Intimacy:{Bonus:1},[v]:{voiceSuffix:"_29",spoiler:!1}}],["Tap",{Name:"GreetAP",Priority:9,Intimacy:{Bonus:1},[v]:{voiceSuffix:"_30",spoiler:!1}}],["Tap",{Name:"GreetBP",Priority:9,Intimacy:{Bonus:1},[v]:{voiceSuffix:"_31",spoiler:!1}}]];class kt{getRoleId(...e){const[t]=e;return t||void 0}getModelId(...e){const[t]=e;return`${t}`}getMotionIndex(...e){const[t]=e;switch(t){case"scene":{const[,o,i]=e;return["Story#1",`${o}_${i+1}`]}case"motion":{const[,o,i]=e;return["Motion#2",`${i}`]}case"voice":{const[,o,i]=e;return["Voice#3",i]}case"voiceFull":{const[,o,i]=e;return["VoiceFull#3",i]}case"face":{const[,o,i]=e,r=ve(i);return["Face#4",r!==void 0?`${r}`:i]}}}getExpressionName(...e){switch(e[0]){case"face":{const[t,o,i]=e;return Se(i)}}}getFilePath(...e){switch(e[0]){case"motion":{const[t,o,i]=e;return`mtn/motion_${i.toString().padStart(3,"0")}.motion3.json`}case"face":{const[t,o,i]=e;return`exp/${Se(i)}`}case"voice":{const[t,o,i]=e;return`../../../sound_native/voice/${i}_hca.mp3`}case"voiceFull":{const[t,o,i]=e;return`../../../sound_native/${i}_hca.mp3`}}}}function ve(n){var o;const e=/^mtn_ex_(?<face>\d{1,})\.exp3?\.json$/,t=(o=n.match(e))==null?void 0:o.groups.face;return t!==void 0?+t:void 0}function Se(n){const e=ve(n);return e!==void 0?`mtn_ex_${`${e}`.padStart(3,"0")}.exp3.json`:n}const Pt=Ie.filter(([,n])=>!n[v].spoiler);function _t(n,e,t,o){const{allowSpoiler:i,otherRoleIds:r}=o!=null?o:{},a=e.story;if(a===void 0)return;const c=i?Ie:Pt,u=new kt;for(const[l,f]of c){const{voiceSuffix:p}=f[v],h=Object.entries(a).find(([,P])=>{var S,_;return(_=(S=P[0])==null?void 0:S.chara)==null?void 0:_.some(A=>{var W;return(W=A.voice)==null?void 0:W.endsWith(p)})});if(h===void 0)continue;const[d,x]=h,g=u.getMotionIndex("scene",d,0),m=$(M({},f),{Command:St(t,r,g,u)});D(n,l,m),gt(n,x,d,t,u)}}const Nt=N(()=>new WeakMap),te=N({},()=>{throw new Error("invalid operation: source is undefined")});function C(n,e){const t=R(Nt)[0],o=e===void 0?te:(()=>{var x,g;const h=(x=t.get(n))!=null?x:(()=>{const m=new WeakMap;return t.set(n,m),m})();return(g=h.get(e))!=null?g:(()=>{const m=N({});return h.set(e,m),m})()})(),i=y.exports.useMemo(()=>e===void 0?te:N(void 0,async(h,d)=>{const x=h(o).loading;if(x!==void 0)try{await x}catch{return}else{const g=n(e);d(o,m=>$(M({},m),{loading:g}));try{d(o,{data:await g})}catch(m){d(o,P=>({data:P.data,error:m}))}}}),[n,o,e]),r=y.exports.useMemo(()=>e===void 0?te:N(void 0,async(h,d)=>{const x=h(o);"data"in x||"error"in x||await d(i)}),[o,i,e]),a=R(o)[0],{data:c,loading:u}=a,l=R(r)[1],f=R(i)[1],p=y.exports.useMemo(()=>$(M(M({},"error"in a?{error:a.error}:{}),e!==void 0?{load:l,reload:f}:{}),{loading:!!u}),[a,e,l,f,u]);return y.exports.useEffect(()=>{e!==void 0&&l()},[l,e]),y.exports.useMemo(()=>[c,p],[c,p])}function ne(n,e){const[t,o]=y.exports.useState({}),{data:i,loading:r}=t,a=y.exports.useRef(t.loading),c=y.exports.useCallback(async()=>{if(e===void 0)throw new Error("invalid operation: source is undefined");if(a.current!==void 0)try{await a.current}catch{return}else{const p=n(e);a.current=p,o(h=>$(M({},h),{loading:p}));try{o({data:await p})}catch(h){o(d=>({data:d.data,error:h}))}finally{a.current=void 0}}},[n,e]),u=y.exports.useCallback(async()=>{"data"in t||"error"in t||await c()},[t,c]),l=y.exports.useCallback(()=>{o(({loading:p})=>({loading:p}))},[]),f=y.exports.useMemo(()=>$(M(M({},"error"in t?{error:t.error}:{}),e!==void 0?{load:u,reload:c}:{}),{loading:!!r}),[t,e,u,c,r]);return y.exports.useEffect(()=>{e!==void 0?c():l()},[c,e,l]),y.exports.useMemo(()=>[i,f],[i,f])}async function bt(n){const e={};for await(const[t,o]of lt(n))e[t]=o;return e}function oe(n){return C(bt,n)}function ie(n){const{title:e,children:t}=n,o=U();return I(k,{children:[s(Ft,{direction:"down",children:s(X,{children:I(b,{sx:{gap:"1em"},children:[s(De,{onClick:()=>o(-1),children:s(Ce,{})}),s(k,{sx:{flex:1},children:e})]})})}),s(b,{}),t]})}function Ft(n){const{children:e,direction:t}=n,o=le();return s(de,{appear:!1,direction:t,in:!o,children:e})}async function Dt(n){const e={};for await(const[t,o]of ct(n))e[t]=o;return e}function Ct(n){return C(Dt,n)}const Tt=new FinalizationRegistry(n=>URL.revokeObjectURL(n));async function At(n){const e=await n.getFile(),t=URL.createObjectURL(e);return Tt.register(n,t),await new Promise((o,i)=>{const r=new Image;r.onload=()=>o(),r.onerror=a=>i(a),r.src=t}),t}function Lt(n,e){const[t]=Ct(n),o=e!==void 0?t==null?void 0:t[e]:void 0;return C(At,o)}async function Rt(n){const e=await ye(n);return await ge(e)}function Me(n,e){const[t,{error:o}]=oe(n),i=e!==void 0?t==null?void 0:t[e]:void 0,[r,a]=C(Rt,i),{error:c}=a,u=y.exports.useMemo(()=>$(M({},a),{error:o!=null?o:c}),[a,c,o]);return y.exports.useMemo(()=>[r,u],[u,r])}const z=Te(void 0),Bt=N(void 0,async(n,e)=>{try{const t=await showDirectoryPicker();e(z,t)}catch(t){if(t instanceof Error&&t.name==="AbortError")return;throw e(z,void 0),t}});function w(){const n=Ae(z),e=Le(Bt),t=Re(z),o=y.exports.useMemo(()=>({request:e,invalidate:t}),[t,e]);return y.exports.useMemo(()=>[n,o],[o,n])}function T(n){var d;const{modelId:e,sx:t,alt:o}=n,i=o!=null?o:`ID: ${e}`,[r,a]=Be({triggerOnce:!0}),[c]=w(),u=a?e:void 0,[l,{loading:f}]=Me(c,u),p=a&&e!==void 0?e-e%100:void 0,[h]=Lt(c,p);return I(k,{sx:M({display:"inline-flex",gap:"1em",alignItems:"center",textAlign:"start"},t),ref:r,children:[s(Oe,{src:h}),I(k,{sx:{flex:"1"},children:[s(q,{children:(d=l==null?void 0:l.charaName)!=null?d:i}),s(q,{sx:{color:"text.secondary",fontSize:"smaller"},children:(l==null?void 0:l.charaName)?i:f?"Loading...":"Unknown"})]})]})}function re(n){const{modelIds:e,selectedModelId:t}=n,o="linkTo"in n?n.linkTo:void 0,i="onSelect"in n?n.onSelect:void 0;return s(B,{children:y.exports.useMemo(()=>e.map(r=>{const a=t===r;return s(Y,$(M({selected:a,ref:c=>{a&&(c==null||c.scrollIntoView({block:"center"}))},onClick:()=>i==null?void 0:i(r)},o!==void 0&&{component:V,to:o(r)}),{children:s(T,{modelId:r,sx:{flex:1}})}),r)}),[o,i,e,t])})}function K(n){const[e,t]=oe(n),o=y.exports.useMemo(()=>e!==void 0?Object.keys(e).map(i=>+i):void 0,[e]);return y.exports.useMemo(()=>[o,t],[t,o])}async function Ot(n){const e={};for await(const[t,o]of pt(n))e[t]=o;return e}function Et(n){return C(Ot,n)}function jt(n,e){const[t]=Et(n),o=e!==void 0?t==null?void 0:t[e]:void 0;return ne(xe,o)}async function Ht(n){const e=[];for await(const t of yt(n))t===void 0||t===0||e.push(t);return e.sort((t,o)=>t-o),e}function Wt(n,e){const[t]=jt(n,e),[o,i]=ne(Ht,t),r=y.exports.useMemo(()=>o!=null?o:e!==void 0?[e]:[],[o,e]);return y.exports.useMemo(()=>[r,i],[i,r])}async function Gt(n){const e={};for await(const[t,o]of ht(n))e[t]=o;return e}function we(n){return C(Gt,n)}function Ut(n,e){const[t]=we(n),o=e!==void 0?t==null?void 0:t[e]:void 0;return ne(xe,o)}function se(n){const[e,t]=we(n),o=y.exports.useMemo(()=>e!==void 0?Object.keys(e).filter(i=>/^\d+$/.test(i)).map(i=>+i):void 0,[e]);return y.exports.useMemo(()=>[o,t],[o,t])}function qt(n){const e=U(),{scenarioId:t}=n,[o]=w(),[i]=K(o),[r,{loading:a}]=Wt(o,t),[c,u]=E(),l=y.exports.useMemo(()=>new Map(c.getAll("cast").map(h=>{var m;const d=h.match(/^(?<roleId>\d+):(?<modelId>\d+)$/),{roleId:x,modelId:g}=(m=d==null?void 0:d.groups)!=null?m:{};return d!==null?[+x,+g]:void 0}).filter(h=>h)),[c]);y.exports.useEffect(()=>{if(r!==void 0){const h=c.getAll("cast"),d=h.filter(x=>r.includes(+x.split(/:/)[0]));if(d.length!==h.length){c.delete("cast");for(const x of d)c.append("cast",x);c.sort(),u(c,{replace:!0})}else if(d.length<r.length&&t!==void 0&&i!==void 0){const x=r.filter(g=>!d.some(m=>m.startsWith(`${g}:`)));for(const g of x){const m=g-g%100;i.includes(g)?c.append("cast",`${g}:${g}`):i.includes(m)&&c.append("cast",`${g}:${m}`)}u(c,{replace:!0})}}},[i,r,t,c,u]);const f=y.exports.useMemo(()=>[{field:"role",headerName:"Role",sortable:!1,flex:1,renderCell(h){const d=h.value;return s(T,{modelId:d,alt:`Role ID: ${d}`})}},{field:"actor",headerName:"Actor Model",sortable:!1,flex:1,renderCell(h){const d=h.value;return I(j,{sx:{display:"flex",width:"100%",height:"100%",alignItems:"center",textDecoration:"none",textTransform:"none",color:"text.primary"},onClick:()=>e(location,{state:{modal:"select-model",roleId:h.row.role}}),children:[s(T,{modelId:d,sx:{flex:1},alt:`Model ID: ${d}`}),s(me,{})]})}}],[e]),p=y.exports.useMemo(()=>{var h;return(h=r==null?void 0:r.map(d=>({id:d,role:d,actor:l.get(d)})))!=null?h:[]},[l,r]);return s(Ue,{columns:f,rows:p,autoHeight:!0,disableColumnFilter:!0,disableColumnSelector:!0,hideFooter:!0,loading:a})}function Vt(){var u;const e=O().state,[t,o]=E(),[i]=w(),[r]=se(i),a=+((u=t.get("scenario"))!=null?u:NaN),c=y.exports.useCallback(l=>{t.set("scenario",`${l}`),t.sort(),o(t,{replace:!0})},[t,o]);return s(Z,{fullScreen:!0,open:(e==null?void 0:e.modal)==="select-scenario",children:s(ie,{title:"select Scenario",children:s(re,{modelIds:r!=null?r:[],onSelect:c,selectedModelId:a})})})}function Jt(){var l,f;const e=O().state,[t,o]=E(),[i]=w(),[r]=K(i),a=e==null?void 0:e.roleId,c=+((f=(l=t.getAll("cast").find(p=>p.startsWith(`${a}:`)))==null?void 0:l.replace(`${a}:`,""))!=null?f:NaN),u=y.exports.useCallback(p=>{if(c===void 0)t.append("cast",`${a}:${p}`);else{const h=t.getAll("cast").map(d=>d.startsWith(`${a}:`)?`${a}:${p}`:d);t.delete("cast");for(const d of h)t.append("cast",d)}t.sort(),o(t,{replace:!0})},[t,c,a,o]);return s(Z,{fullScreen:!0,open:(e==null?void 0:e.modal)==="select-model",children:s(ie,{title:I(k,{sx:{display:"inline-flex",alignItems:"center",gap:"1em"},children:["select Model for Role",s(T,{modelId:a})]}),children:s(re,{modelIds:r!=null?r:[],onSelect:u,selectedModelId:c})})})}function zt(){const[n]=w(),[e]=oe(n),t=O(),o=t.state,i=U(),[r]=E(),[a,c]=y.exports.useState(!1),u=r.get("allow-spoiler")!==null,l=(g=>g!==null?+g:void 0)(r.get("scenario")),[f]=Ut(n,l),p=y.exports.useMemo(()=>r.getAll("cast").map(g=>{var _;const m=g.match(/^(?<roleId>\d+):(?<modelId>\d+)$/),{roleId:P,modelId:S}=(_=m==null?void 0:m.groups)!=null?_:{};return m!==null?[+P,+S]:void 0}).filter(g=>g),[r]),h=y.exports.useCallback(([g,m])=>`image_native/live2d_v4/${m}/model-${p.length===1?`${l}`:`${l}@${g}`}.json`,[p.length,l]),d=y.exports.useMemo(()=>p.map(h),[p,h]),x=y.exports.useCallback(()=>{if(l===void 0||f===void 0)throw new Error("scenario is undefined");c(!0);const g=p.map(([m])=>m);Promise.all(p.map(async([m,P])=>{const S=e==null?void 0:e[P];if(S===void 0)throw new Error("modelDirectory is undefined");const _=new Set(g);_.delete(m);const[A,W]=await Promise.all([dt(S).then(L=>ft(L)),ye(S).then(L=>ge(L))]);_t(A,f,m,{allowSpoiler:u,otherRoleIds:_}),vt(A,W);const G=await ut(S,p.length===1?`${l}`:`${l}@${m}`);try{await G.truncate(0),await mt(G,A),await G.close()}catch(L){throw await G.abort(),L}})).then(()=>({severity:"success",message:"succeeded to generate models"}),m=>({severity:"error",error:`${m.message}`})).then(m=>i(t,{state:{snackbar:m}})).finally(()=>c(!1))},[u,p,t,e,i,f,l]);return I(Z,{open:(o==null?void 0:o.modal)==="confirm",onClose:()=>i(t,{replace:!0}),children:[I(qe,{children:[I(Ve,{children:["The following",d.length>1?" files ":" file ","will be created on your disk."]}),s("ul",{children:d.map(g=>s("li",{children:g},g))})]}),I(Je,{children:[s(j,{onClick:()=>i(t,{replace:!0}),children:"Cancel"}),I(ze,{variant:"contained",loading:a,onClick:x,children:["Create ",d.length>1?" those files ":" this file "]})]})]})}function Kt(){var h,d;const n=O(),e=n.state,t=U(),[o,{request:i}]=w(),[r]=K(o),[a]=se(o),[c,u]=E(),l=c.get("scenario");l!==null&&!/^\d+$/.test(l)&&t($(M({},n),{search:""}));const f=l!==null?+l:void 0,p=o===void 0||f===void 0;return y.exports.useEffect(()=>{f===void 0&&r!==void 0&&r.length>0&&(c.set("scenario",`${r[0]}`),u(c))},[r,f,c,u]),y.exports.useEffect(()=>{if(f!==void 0&&a!==void 0&&!a.includes(f)){const x=f-f%100;a.includes(x)?(c.set("scenario",`${x}`),u(c)):(c.delete("scenario"),u(c))}},[f,a,c,u]),I(ue,{children:[I(k,{children:[s(X,{children:I(b,{children:[s(k,{sx:{flex:1},children:"Generate EX Model"}),o===void 0&&s(j,{variant:"contained",startIcon:s(fe,{}),onClick:i,children:"specify resource directory"})]})}),s(b,{}),I(B,{children:[s(Q,{children:"Scenario"}),s(H,{disablePadding:!0,children:I(Y,{onClick:()=>o!==void 0?t(n,{state:{modal:"select-scenario"}}):i(),children:[s(T,{modelId:f,alt:`Scenario ID: ${f}`,sx:{flex:1}}),s(me,{})]})}),s(Q,{children:"Cast"}),s(H,{disablePadding:!0,children:s(qt,{scenarioId:f})}),s(Q,{children:"Option"}),s(H,{children:s(Ee,{children:s(je,{control:s(He,{checked:c.has("allow-spoiler"),onChange:(x,g)=>{g?c.set("allow-spoiler","true"):c.delete("allow-spoiler"),c.sort(),u(c,{replace:!0})}}),label:I(ue,{children:[s(q,{children:"Allow spoiler"}),s(q,{sx:{color:"text.secondary",fontSize:"smaller"},children:"Allow model reactions that has not yet appeared in the game."})]})})})})]}),s(j,{variant:"contained",fullWidth:!0,disabled:p,onClick:()=>t(n,{state:{modal:"confirm"},replace:!0}),children:"Generate Model"})]}),s(Vt,{}),s(Jt,{}),s(zt,{}),s(We,{open:(e==null?void 0:e.snackbar)!==void 0,autoHideDuration:6e3,children:s(Ge,{severity:(h=e==null?void 0:e.snackbar)==null?void 0:h.severity,children:(d=e==null?void 0:e.snackbar)==null?void 0:d.message})})]})}function Xt(){var r;const{modelId:n}=he();if(n===void 0||!/^\d+/.test(n))throw new Error("invalid modelId");const e=+n,[t]=w(),[o,{loading:i}]=Me(t,e);return s(B,{children:I(H,{children:["details:",(r=o==null?void 0:o.charaName)!=null?r:i?"Loading...":"Unknown"]})})}const Yt=N(void 0);function $e(){return R(Yt)}function Qt(n){const{title:e,children:t}=n,i=O().pathname.replace(/(?<!^)\/.*/,""),[r,{request:a}]=w(),[c]=$e();return I(k,{sx:{height:"100vh"},children:[s(Zt,{direction:"down",children:s(X,{children:I(b,{children:[s(k,{sx:{flex:1},children:e}),r===void 0&&s(j,{variant:"contained",startIcon:s(fe,{}),onClick:a,children:"specify resource directory"})]})})}),s(b,{}),t,s(Ke,{sx:{position:"fixed",bottom:0,left:0,right:0},elevation:3,square:!0,children:I(Xe,{showLabels:!0,value:i,sx:{background:"transparent"},children:[s(pe,{component:V,to:"/model",value:"/model",label:"Models",icon:s(Ye,{})}),s(pe,{component:V,to:{pathname:"/bake",search:`${c!=null?c:""}`},value:"/bake",label:"Generate EX Model",icon:s(Qe,{})})]})})]})}function Zt(n){const{children:e,direction:t}=n,o=le();return s(de,{appear:!1,direction:t,in:!o,children:e})}function en(){const[n]=w(),[e]=K(n);return s(Qt,{title:"Models",children:s(B,{children:y.exports.useMemo(()=>e==null?void 0:e.map(t=>s(Y,{component:V,to:`${t}`,children:s(T,{modelId:t})},t)),[e])})})}function tn(){const n=he();return s(B,{children:I(H,{children:["details ",JSON.stringify(n)]})})}function nn(){const[n]=w(),[e]=se(n);return s(ie,{title:"Scenario",children:s(re,{modelIds:e!=null?e:[],linkTo:t=>`${t}`})})}function on(){const[n]=$e();return I(it,{children:[s(F,{path:"/model",element:s(en,{})}),s(F,{path:"/model/:modelId",element:s(Xt,{})}),s(F,{path:"/scenario",element:s(nn,{})}),s(F,{path:"/scenario/:scenarioId",element:s(tn,{})}),s(F,{path:"/bake",element:s(Kt,{})}),s(F,{path:"*",element:s(rt,{to:`/bake${n===void 0?"":`?${n}`}`})})]})}function rn(){const n=Ze("(prefers-color-scheme: dark)"),e=y.exports.useMemo(()=>et({palette:{mode:n?"dark":"light"}}),[n]);return I(tt,{theme:e,children:[s(nt,{}),s(ot,{basename:"/mgrcd",children:s(on,{})})]})}st.exports.render(s(y.exports.StrictMode,{children:s(rn,{})}),document.getElementById("root"));
