var ke=Object.defineProperty,$e=Object.defineProperties;var _e=Object.getOwnPropertyDescriptors;var ae=Object.getOwnPropertySymbols;var Ne=Object.prototype.hasOwnProperty,Fe=Object.prototype.propertyIsEnumerable;var ce=(n,e,t)=>e in n?ke(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,M=(n,e)=>{for(var t in e||(e={}))Ne.call(e,t)&&ce(n,t,e[t]);if(ae)for(var t of ae(e))Fe.call(e,t)&&ce(n,t,e[t]);return n},$=(n,e)=>$e(n,_e(e));import{h as be,a as N,r as y,u as L,b as U,j as I,B as _,c,A as V,T as b,I as De,d as Ce,e as le,S as de,f as Te,g as Ae,i as Re,k as Le,l as Oe,m as Be,n as q,L as O,o as X,p as z,q as B,s as E,F as ue,t as j,v as fe,w as Q,x as H,C as me,y as Ee,z as je,D as He,E as We,G as Ge,H as Ue,J as Z,K as qe,M as ze,N as Je,O as Ye,P as pe,Q as Ke,R as Ve,U as he,V as Xe,W as Qe,X as Ze,Y as et,Z as tt,_ as nt,$ as ot,a0 as it,a1 as D,a2 as rt,a3 as st}from"./vendor.a63c22a0.js";const at=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}};at();const ct=["image_native","mini","image"];async function*lt(n){var t,o;const e=await ct.reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const s=(o=(t=i.match(/^mini_(?<id>\d{6})_d\.png$/))==null?void 0:t.groups)==null?void 0:o.id;s!==void 0&&r instanceof FileSystemFileHandle&&(yield[+s,r])}}async function dt(n){return JSON.parse(n)}function ut(n,e){return JSON.stringify(n,null,e)}async function ft(n){return be.parse(n)}async function mt(n){return JSON.parse(n)}const pt=["image_native","live2d_v4"],ht="model.model3.json",yt="params.json";async function*gt(n){var t,o;const e=await pt.reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const s=(o=(t=i.match(/^(?<id>\d{6})$/))==null?void 0:t.groups)==null?void 0:o.id;s!==void 0&&r instanceof FileSystemDirectoryHandle&&(yield[+s,r])}}async function xt(n){return await n.getFileHandle(ht)}async function ye(n){return await n.getFileHandle(yt)}async function It(n,e){return await n.getFileHandle(`model-${e}.model3.json`,{create:!0}).then(t=>t.createWritable())}async function St(n){return await n.getFile().then(e=>e.text()).then(e=>dt(e))}async function vt(n,e){const t=ut(e,"	");await n.write(t)}async function ge(n){return await n.getFile().then(e=>e.text()).then(e=>ft(e))}const Mt=["scenario","json","general"],wt=["scenario","json","charaOneShot"];async function*Pt(n){var t,o;const e=await Mt.reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const s=(o=(t=i.match(/^(?<id>\d{6})\.json$/))==null?void 0:t.groups)==null?void 0:o.id;s!==void 0&&r instanceof FileSystemFileHandle&&(yield[+s,r])}}async function*kt(n){var t,o;const e=await wt.reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const s=(o=(t=i.match(/^(?<id>\d{6})\.json$/))==null?void 0:t.groups)==null?void 0:o.id;s!==void 0&&r instanceof FileSystemFileHandle&&(yield[+s,r])}}async function xe(n){return await n.getFile().then(e=>e.text()).then(e=>mt(e))}function $t(n,e,t,o,i){var r;for(const[s,a]of e.entries()){const d=i.getMotionIndex("scene",t,s),[l,f]=d,m=s+1<e.length?i.getMotionIndex("scene",t,s+1).join(":"):void 0,p=a.autoTurnFirst!==void 0?a.autoTurnFirst*1e3:a.autoTurnLast!==void 0?a.autoTurnLast*1e3:void 0,u=(r=a.chara)!=null?r:[],x=Ct(o,u,i),h=Tt(o,u,i);Dt(n,o,u,i),C(n,l,{Name:f,MotionDuration:p,Command:x,Text:h,NextMtn:m})}}function J([n,e]){return e!==void 0?`${n}:${e}`:n}function ee(n,[e,t]){var o,i;return t!==void 0&&!!((i=(o=n.FileReferences.Motions)==null?void 0:o[e])==null?void 0:i.some(r=>r.Name===t))}function _t(n,e){var t;return!!((t=n.FileReferences.Expressions)==null?void 0:t.some(o=>o.Name===e))}function C(n,e,t){var r,s,a,d;const o=(d=(a=(s=(r=n.FileReferences).Motions)!=null?s:r.Motions={})[e])!=null?d:a[e]=[],i=t.Name;if(i===void 0)o.push(t);else{const l=o.findIndex(f=>f.Name===i);l>=0?o.splice(l,1,t):o.push(t)}}function Nt(n,e){var r,s;const t=(s=(r=n.FileReferences).Expressions)!=null?s:r.Expressions=[],o=e.Name,i=t.findIndex(a=>a.Name!==o);i>=0?t.splice(i,1,e):t.push(e)}function Ft(n,e){var o;const t=(o=n.Options)!=null?o:n.Options={};t.Name=e.charaName,t.ScaleFactor=e.modelScale}function bt(n,e,t,o){const i=J(t),r=[`start_mtn ${i}`];for(const s of e!=null?e:[])s===n||s===void 0||r.push(`start_mtn ${o.getModelId(s)} ${i}`);return r.join(";")}function Dt(n,e,t,o){for(const i of t){if(o.getRoleId(i.id)!==e)continue;const{motion:r,face:s,voice:a}=i;if(r!==void 0){const d=o.getMotionIndex("motion",e,r);if(!ee(n,d)){const[l,f]=d,m=o.getFilePath("motion",e,r);r<100?C(n,l,{Name:f,File:m,FileLoop:!0,Command:"eye_blink enforce",FadeOut:0}):C(n,l,{Name:f,Command:"eye_blink enforce",File:m})}}if(s!==void 0){const d=o.getMotionIndex("face",e,s),l=o.getExpressionName("face",e,s);if(!ee(n,d)){const[f,m]=d;C(n,f,{Name:m,Expression:l})}if(!_t(n,l)){const f=o.getFilePath("face",e,s);Nt(n,{Name:l,File:f})}}if(a!==void 0){const d=o.getMotionIndex("voice",e,a);if(!ee(n,d)){const[l,f]=d,m=o.getFilePath("voice",e,a);C(n,l,{Name:f,Sound:m})}}}}function Ct(n,e,t){var i;const o=[];for(const r of e){if(t.getRoleId(r.id)!==n)continue;const{motion:s,face:a,voice:d,lipSynch:l,cheek:f,eyeClose:m,mouthOpen:p,soulGem:u,tear:x,live2dParam:h,textHomeStatus:g}=r;if(s!==void 0){const v=t.getMotionIndex("motion",n,s);o.push(`start_mtn ${J(v)}`)}if(a!==void 0){const v=t.getMotionIndex("face",n,a);o.push(`start_mtn ${J(v)}`)}if(d!==void 0){const v=t.getMotionIndex("voice",n,d);o.push(`start_mtn ${J(v)}`)}if(l!==void 0&&(l?o.push("unmute_sound 0","lip_sync enable","parameters unlock ParamMouthOpenY"):e.some(v=>v.lipSynch)?o.push("mute_sound 0"):o.push("lip_sync disable","parameters lock ParamMouthOpenY 0")),f!==void 0&&o.push(`parameters lock ParamCheek ${f}`),m!==void 0&&(m===0?o.push("parameters unlock ParamEyeLOpen","parameters unlock ParamEyeROpen"):o.push(`parameters lock ParamEyeLOpen ${1-m}`,`parameters lock ParamEyeROpen ${1-m}`)),p!==void 0&&(p===0?o.push("parameters unlock ParamMouthOpenY"):o.push(`parameters lock ParamMouthOpenY ${p}`)),u!==void 0&&(u===1?o.push("parameters unlock ParamSoulgem"):o.push(`parameters lock ParamSoulgem ${u}`)),x!==void 0&&(x===0?o.push("parameters unlock ParamTear"):o.push(`parameters lock ParamTear ${x}`)),(h==null?void 0:h.name)!==void 0){const v=h.name.replace(/_?([A-Za-z]+)/g,(P,w)=>`${w[0].toUpperCase()}${w.slice(1).toLowerCase()}`);o.push(`parameters lock ${v} ${(i=h.value)!=null?i:0}`)}g==="Clear"&&o.push("hide_text")}return o.join(";")||void 0}function Tt(n,e,t){const o=[];for(const i of e){if(t.getRoleId(i.id)!==n)continue;const{textHome:r}=i;if(r!==void 0){const s=r.replace(/\[.*?\]/g,"").replace(/@/g,`
`);o.push(s)}}return o.join("{$br}")||void 0}const S=Symbol("metaKey"),Ie=[["Start",{Name:"Intro1",Priority:9,Intimacy:{Max:0},[S]:{voiceSuffix:"_01",spoiler:!1}}],["Start",{Name:"Intro2",Priority:9,Intimacy:{Max:0},[S]:{voiceSuffix:"_02",spoiler:!1}}],["Start",{Name:"GreetFirst",Priority:9,Intimacy:{Min:1,Bonus:4},[S]:{voiceSuffix:"_24",spoiler:!1}}],["Tap",{Name:"Talk1",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_33",spoiler:!1}}],["Tap",{Name:"Talk2",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_34",spoiler:!1}}],["Tap",{Name:"Talk3",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_35",spoiler:!1}}],["Tap",{Name:"Talk4",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_36",spoiler:!1}}],["Tap",{Name:"Talk5",Priority:9,Intimacy:{Min:8,Bonus:1},[S]:{voiceSuffix:"_37",spoiler:!1}}],["Tap",{Name:"Talk6",Priority:9,Intimacy:{Min:16,Bonus:1},[S]:{voiceSuffix:"_38",spoiler:!1}}],["Tap",{Name:"Talk7",Priority:9,Intimacy:{Min:24,Bonus:1},[S]:{voiceSuffix:"_39",spoiler:!1}}],["Tap",{Name:"Talk8",Priority:9,Intimacy:{Min:32,Bonus:1},[S]:{voiceSuffix:"_40",spoiler:!1}}],["Tap",{Name:"Talk9",Priority:9,Intimacy:{Min:40,Bonus:1},[S]:{voiceSuffix:"_41",spoiler:!1}}],["Tap",{Name:"Talk10",Priority:9,Intimacy:{Min:48,Bonus:1},[S]:{voiceSuffix:"_32",spoiler:!0}}],["Tap",{Name:"GreetMorning",Priority:9,Weight:2,TimeLimit:{Hour:6,Sustain:180},Intimacy:{Bonus:1},[S]:{voiceSuffix:"_25",spoiler:!1}}],["Tap",{Name:"GreetDay",Priority:9,Weight:2,TimeLimit:{Hour:11,Sustain:120},Intimacy:{Bonus:1},[S]:{voiceSuffix:"_26",spoiler:!1}}],["Tap",{Name:"GreetEvening",Priority:9,Weight:2,TimeLimit:{Hour:17,Sustain:120},Intimacy:{Bonus:1},[S]:{voiceSuffix:"_27",spoiler:!1}}],["Tap",{Name:"GreetNight",Priority:9,Weight:2,TimeLimit:{Hour:22,Sustain:120},Intimacy:{Bonus:1},[S]:{voiceSuffix:"_28",spoiler:!1}}],["Tap",{Name:"Greet",Priority:9,ignorable:!0,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_29",spoiler:!1}}],["Tap",{Name:"GreetAP",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_30",spoiler:!1}}],["Tap",{Name:"GreetBP",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_31",spoiler:!1}}]];class At{getRoleId(...e){const[t]=e;return t||void 0}getModelId(...e){const[t]=e;return`${t}`}getMotionIndex(...e){const[t]=e;switch(t){case"scene":{const[,o,i]=e;return["Story#1",`${o}_${i+1}`]}case"motion":{const[,o,i]=e;return["Motion#2",`${i}`]}case"voice":{const[,o,i]=e;return["Voice#3",i]}case"voiceFull":{const[,o,i]=e;return["VoiceFull#3",i]}case"face":{const[,o,i]=e,r=Se(i);return["Face#4",r!==void 0?`${r}`:i]}}}getExpressionName(...e){switch(e[0]){case"face":{const[t,o,i]=e;return ve(i)}}}getFilePath(...e){switch(e[0]){case"motion":{const[t,o,i]=e;return`mtn/motion_${i.toString().padStart(3,"0")}.motion3.json`}case"face":{const[t,o,i]=e;return`exp/${ve(i)}`}case"voice":{const[t,o,i]=e;return`../../../sound_native/voice/${i}_hca.mp3`}case"voiceFull":{const[t,o,i]=e;return`../../../sound_native/${i}_hca.mp3`}}}}function Se(n){var o;const e=/^mtn_ex_(?<face>\d{1,})\.exp3?\.json$/,t=(o=n.match(e))==null?void 0:o.groups.face;return t!==void 0?+t:void 0}function ve(n){const e=Se(n);return e!==void 0?`mtn_ex_${`${e}`.padStart(3,"0")}.exp3.json`:n}const Rt=Ie.filter(([,n])=>!n[S].spoiler);function Lt(n,e,t,o){const{allowSpoiler:i,otherRoleIds:r}=o!=null?o:{},s=e.story;if(s===void 0)return;const a=i?Ie:Rt,d=new At;for(const[l,f]of a){const{voiceSuffix:m}=f[S],p=Object.entries(s).find(([,v])=>{var P,w;return(w=(P=v[0])==null?void 0:P.chara)==null?void 0:w.some(F=>{var W;return(W=F.voice)==null?void 0:W.endsWith(m)})});if(p===void 0)continue;const[u,x]=p,h=d.getMotionIndex("scene",u,0),g=$(M({},f),{Command:bt(t,r,h,d)});C(n,l,g),$t(n,x,u,t,d)}}function Ot(n,e){var r,s,a;const t=(r=n.Controllers)!=null?r:n.Controllers={},o=(s=n.Options)!=null?s:n.Options={},i=Object.values((a=n.FileReferences.Motions)!=null?a:{}).flat().reduce((d,l)=>{var f;return((f=l.Intimacy)==null?void 0:f.Min)?Math.max(d!=null?d:0,l.Intimacy.Min):d},void 0);t.IntimacySystem={Enabled:!0,MaxValue:i},o.Id=`${e}`,o.AnisoLevel=2}const Bt=N(()=>new WeakMap),te=N({},()=>{throw new Error("invalid operation: source is undefined")});function T(n,e){const t=L(Bt)[0],o=e===void 0?te:(()=>{var x,h;const p=(x=t.get(n))!=null?x:(()=>{const g=new WeakMap;return t.set(n,g),g})();return(h=p.get(e))!=null?h:(()=>{const g=N({});return p.set(e,g),g})()})(),i=y.exports.useMemo(()=>e===void 0?te:N(void 0,async(p,u)=>{const x=p(o).loading;if(x!==void 0)try{await x}catch{return}else{const h=n(e);u(o,g=>$(M({},g),{loading:h}));try{u(o,{data:await h})}catch(g){u(o,v=>({data:v.data,error:g}))}}}),[n,o,e]),r=y.exports.useMemo(()=>e===void 0?te:N(void 0,async(p,u)=>{const x=p(o);"data"in x||"error"in x||await u(i)}),[o,i,e]),s=L(o)[0],{data:a,loading:d}=s,l=L(r)[1],f=L(i)[1],m=y.exports.useMemo(()=>$(M(M({},"error"in s?{error:s.error}:{}),e!==void 0?{load:l,reload:f}:{}),{loading:!!d}),[s,e,l,f,d]);return y.exports.useEffect(()=>{e!==void 0&&l()},[l,e]),y.exports.useMemo(()=>[a,m],[a,m])}function ne(n,e){const[t,o]=y.exports.useState({}),{data:i,loading:r}=t,s=y.exports.useRef(t.loading),a=y.exports.useCallback(async()=>{if(e===void 0)throw new Error("invalid operation: source is undefined");if(s.current!==void 0)try{await s.current}catch{return}else{const m=n(e);s.current=m,o(p=>$(M({},p),{loading:m}));try{o({data:await m})}catch(p){o(u=>({data:u.data,error:p}))}finally{s.current=void 0}}},[n,e]),d=y.exports.useCallback(async()=>{"data"in t||"error"in t||await a()},[t,a]),l=y.exports.useCallback(()=>{o(({loading:m})=>({loading:m}))},[]),f=y.exports.useMemo(()=>$(M(M({},"error"in t?{error:t.error}:{}),e!==void 0?{load:d,reload:a}:{}),{loading:!!r}),[t,e,d,a,r]);return y.exports.useEffect(()=>{e!==void 0?a():l()},[a,e,l]),y.exports.useMemo(()=>[i,f],[i,f])}async function Et(n){const e={};for await(const[t,o]of gt(n))e[t]=o;return e}function oe(n){return T(Et,n)}function ie(n){const{title:e,children:t}=n,o=U();return I(_,{children:[c(jt,{direction:"down",children:c(V,{children:I(b,{sx:{gap:"1em"},children:[c(De,{onClick:()=>o(-1),children:c(Ce,{})}),c(_,{sx:{flex:1},children:e})]})})}),c(b,{}),t]})}function jt(n){const{children:e,direction:t}=n,o=le();return c(de,{appear:!1,direction:t,in:!o,children:e})}async function Ht(n){const e={};for await(const[t,o]of lt(n))e[t]=o;return e}function Wt(n){return T(Ht,n)}const Gt=new FinalizationRegistry(n=>URL.revokeObjectURL(n));async function Ut(n){const e=await n.getFile(),t=URL.createObjectURL(e);return Gt.register(n,t),await new Promise((o,i)=>{const r=new Image;r.onload=()=>o(),r.onerror=s=>i(s),r.src=t}),t}function qt(n,e){const[t]=Wt(n),o=e!==void 0?t==null?void 0:t[e]:void 0;return T(Ut,o)}async function zt(n){const e=await ye(n);return await ge(e)}function Me(n,e){const[t,{error:o}]=oe(n),i=e!==void 0?t==null?void 0:t[e]:void 0,[r,s]=T(zt,i),{error:a}=s,d=y.exports.useMemo(()=>$(M({},s),{error:o!=null?o:a}),[s,a,o]);return y.exports.useMemo(()=>[r,d],[d,r])}const Y=Te(void 0),Jt=N(void 0,async(n,e)=>{try{const t=await showDirectoryPicker();e(Y,t)}catch(t){if(t instanceof Error&&t.name==="AbortError")return;throw e(Y,void 0),t}});function k(){const n=Ae(Y),e=Re(Jt),t=Le(Y),o=y.exports.useMemo(()=>({request:e,invalidate:t}),[t,e]);return y.exports.useMemo(()=>[n,o],[o,n])}function A(n){var u;const{modelId:e,sx:t,alt:o}=n,i=o!=null?o:`ID: ${e}`,[r,s]=Oe({triggerOnce:!0}),[a]=k(),d=s?e:void 0,[l,{loading:f}]=Me(a,d),m=s&&e!==void 0?e-e%100:void 0,[p]=qt(a,m);return I(_,{sx:M({display:"inline-flex",gap:"1em",alignItems:"center",textAlign:"start"},t),ref:r,children:[c(Be,{src:p}),I(_,{sx:{flex:"1"},children:[c(q,{children:(u=l==null?void 0:l.charaName)!=null?u:i}),c(q,{sx:{color:"text.secondary",fontSize:"smaller"},children:(l==null?void 0:l.charaName)?i:f?"Loading...":"Unknown"})]})]})}function re(n){const{modelIds:e,selectedModelId:t}=n,o="linkTo"in n?n.linkTo:void 0,i="onSelect"in n?n.onSelect:void 0;return c(O,{children:y.exports.useMemo(()=>e.map(r=>{const s=t===r;return c(X,$(M({selected:s,ref:a=>{s&&(a==null||a.scrollIntoView({block:"center"}))},onClick:()=>i==null?void 0:i(r)},o!==void 0&&{component:z,to:o(r)}),{children:c(A,{modelId:r,sx:{flex:1}})}),r)}),[o,i,e,t])})}function K(n){const[e,t]=oe(n),o=y.exports.useMemo(()=>e!==void 0?Object.keys(e).map(i=>+i):void 0,[e]);return y.exports.useMemo(()=>[o,t],[t,o])}async function Yt(n){const e={};for await(const[t,o]of kt(n))e[t]=o;return e}function Kt(n){return T(Yt,n)}function Vt(n,e){const[t]=Kt(n),o=e!==void 0?t==null?void 0:t[e]:void 0;return ne(xe,o)}async function*Xt(n){var t,o;const e=new Set;for(const i of Object.values((t=n.story)!=null?t:{}))for(const r of i)for(const s of(o=r.chara)!=null?o:[]){const a=s.id;e.has(a)||(yield a,e.add(a))}}async function Qt(n){const e=[];for await(const t of Xt(n))t===void 0||t===0||e.push(t);return e.sort((t,o)=>t-o),e}function Zt(n,e){const[t]=Vt(n,e),[o,i]=ne(Qt,t),r=y.exports.useMemo(()=>o!=null?o:e!==void 0?[e]:[],[o,e]);return y.exports.useMemo(()=>[r,i],[i,r])}async function en(n){const e={};for await(const[t,o]of Pt(n))e[t]=o;return e}function we(n){return T(en,n)}function tn(n,e){const[t]=we(n),o=e!==void 0?t==null?void 0:t[e]:void 0;return ne(xe,o)}function se(n){const[e,t]=we(n),o=y.exports.useMemo(()=>e!==void 0?Object.keys(e).filter(i=>/^\d+$/.test(i)).map(i=>+i):void 0,[e]);return y.exports.useMemo(()=>[o,t],[o,t])}function nn(n){const e=U(),{scenarioId:t}=n,[o]=k(),[i]=K(o),[r,{loading:s}]=Zt(o,t),[a,d]=E(),l=y.exports.useMemo(()=>new Map(a.getAll("cast").map(p=>{var g;const u=p.match(/^(?<roleId>\d+):(?<modelId>\d+)$/),{roleId:x,modelId:h}=(g=u==null?void 0:u.groups)!=null?g:{};return u!==null?[+x,+h]:void 0}).filter(p=>p)),[a]);y.exports.useEffect(()=>{if(r!==void 0){const p=a.getAll("cast"),u=p.filter(x=>r.includes(+x.split(/:/)[0]));if(u.length!==p.length){a.delete("cast");for(const x of u)a.append("cast",x);a.sort(),d(a,{replace:!0})}else if(u.length<r.length&&t!==void 0&&i!==void 0){const x=r.filter(h=>!u.some(g=>g.startsWith(`${h}:`)));for(const h of x){const g=h-h%100;i.includes(h)?a.append("cast",`${h}:${h}`):i.includes(g)&&a.append("cast",`${h}:${g}`)}d(a,{replace:!0})}}},[i,r,t,a,d]);const f=y.exports.useMemo(()=>[{field:"role",headerName:"Role",sortable:!1,flex:1,renderCell(p){const u=p.value;return c(A,{modelId:u,alt:`Role ID: ${u}`})}},{field:"actor",headerName:"Actor Model",sortable:!1,flex:1,renderCell(p){const u=p.value;return I(j,{sx:{display:"flex",width:"100%",height:"100%",alignItems:"center",textDecoration:"none",textTransform:"none",color:"text.primary"},onClick:()=>e(location,{state:{modal:"select-model",roleId:p.row.role}}),children:[c(A,{modelId:u,sx:{flex:1},alt:`Model ID: ${u}`}),c(me,{})]})}}],[e]),m=y.exports.useMemo(()=>{var p;return(p=r==null?void 0:r.map(u=>({id:u,role:u,actor:l.get(u)})))!=null?p:[]},[l,r]);return c(Ue,{columns:f,rows:m,autoHeight:!0,disableColumnFilter:!0,disableColumnSelector:!0,hideFooter:!0,loading:s})}function on(){var d;const e=B().state,[t,o]=E(),[i]=k(),[r]=se(i),s=+((d=t.get("scenario"))!=null?d:NaN),a=y.exports.useCallback(l=>{t.set("scenario",`${l}`),t.sort(),o(t,{replace:!0})},[t,o]);return c(Z,{fullScreen:!0,open:(e==null?void 0:e.modal)==="select-scenario",children:c(ie,{title:"select Scenario",children:c(re,{modelIds:r!=null?r:[],onSelect:a,selectedModelId:s})})})}function rn(){var l,f;const e=B().state,[t,o]=E(),[i]=k(),[r]=K(i),s=e==null?void 0:e.roleId,a=+((f=(l=t.getAll("cast").find(m=>m.startsWith(`${s}:`)))==null?void 0:l.replace(`${s}:`,""))!=null?f:NaN),d=y.exports.useCallback(m=>{if(a===void 0)t.append("cast",`${s}:${m}`);else{const p=t.getAll("cast").map(u=>u.startsWith(`${s}:`)?`${s}:${m}`:u);t.delete("cast");for(const u of p)t.append("cast",u)}t.sort(),o(t,{replace:!0})},[t,a,s,o]);return c(Z,{fullScreen:!0,open:(e==null?void 0:e.modal)==="select-model",children:c(ie,{title:I(_,{sx:{display:"inline-flex",alignItems:"center",gap:"1em"},children:["select Model for Role",c(A,{modelId:s})]}),children:c(re,{modelIds:r!=null?r:[],onSelect:d,selectedModelId:a})})})}function sn(){const[n]=k(),[e]=oe(n),t=B(),o=t.state,i=U(),[r]=E(),[s,a]=y.exports.useState(!1),d=r.get("allow-spoiler")!==null,l=(h=>h!==null?+h:void 0)(r.get("scenario")),[f]=tn(n,l),m=y.exports.useMemo(()=>r.getAll("cast").map(h=>{var w;const g=h.match(/^(?<roleId>\d+):(?<modelId>\d+)$/),{roleId:v,modelId:P}=(w=g==null?void 0:g.groups)!=null?w:{};return g!==null?[+v,+P]:void 0}).filter(h=>h),[r]),p=y.exports.useCallback(([h,g])=>`image_native/live2d_v4/${g}/model-${m.length===1?`${l}`:`${l}@${h}`}.json`,[m.length,l]),u=y.exports.useMemo(()=>m.map(p),[m,p]),x=y.exports.useCallback(()=>{if(l===void 0||f===void 0)throw new Error("scenario is undefined");a(!0);const h=m.map(([g])=>g);Promise.all(m.map(async([g,v])=>{const P=e==null?void 0:e[v];if(P===void 0)throw new Error("modelDirectory is undefined");const w=new Set(h);w.delete(g);const[F,W]=await Promise.all([xt(P).then(R=>St(R)),ye(P).then(R=>ge(R))]);Lt(F,f,g,{allowSpoiler:d,otherRoleIds:w}),Ft(F,W),Ot(F,g);const G=await It(P,m.length===1?`${l}`:`${l}@${g}`);try{await G.truncate(0),await vt(G,F),await G.close()}catch(R){throw await G.abort(),R}})).then(()=>({severity:"success",message:"succeeded to generate models"}),g=>({severity:"error",error:`${g.message}`})).then(g=>i(t,{state:{snackbar:g}})).finally(()=>a(!1))},[d,m,t,e,i,f,l]);return I(Z,{open:(o==null?void 0:o.modal)==="confirm",onClose:()=>i(t,{replace:!0}),children:[I(qe,{children:[I(ze,{children:["The following",u.length>1?" files ":" file ","will be created on your disk."]}),c("ul",{children:u.map(h=>c("li",{children:h},h))})]}),I(Je,{children:[c(j,{onClick:()=>i(t,{replace:!0}),children:"Cancel"}),I(Ye,{variant:"contained",loading:s,onClick:x,children:["Create ",u.length>1?" those files ":" this file "]})]})]})}function an(){var p,u;const n=B(),e=n.state,t=U(),[o,{request:i}]=k(),[r]=K(o),[s]=se(o),[a,d]=E(),l=a.get("scenario");l!==null&&!/^\d+$/.test(l)&&t($(M({},n),{search:""}));const f=l!==null?+l:void 0,m=o===void 0||f===void 0;return y.exports.useEffect(()=>{f===void 0&&r!==void 0&&r.length>0&&(a.set("scenario",`${r[0]}`),d(a))},[r,f,a,d]),y.exports.useEffect(()=>{if(f!==void 0&&s!==void 0&&!s.includes(f)){const x=f-f%100;s.includes(x)?(a.set("scenario",`${x}`),d(a)):(a.delete("scenario"),d(a))}},[f,s,a,d]),I(ue,{children:[I(_,{children:[c(V,{children:I(b,{children:[c(_,{sx:{flex:1},children:"Generate EX Model"}),o===void 0&&c(j,{variant:"contained",startIcon:c(fe,{}),onClick:i,children:"specify resource directory"})]})}),c(b,{}),I(O,{children:[c(Q,{children:"Scenario"}),c(H,{disablePadding:!0,children:I(X,{onClick:()=>o!==void 0?t(n,{state:{modal:"select-scenario"}}):i(),children:[c(A,{modelId:f,alt:`Scenario ID: ${f}`,sx:{flex:1}}),c(me,{})]})}),c(Q,{children:"Cast"}),c(H,{disablePadding:!0,children:c(nn,{scenarioId:f})}),c(Q,{children:"Option"}),c(H,{children:c(Ee,{children:c(je,{control:c(He,{checked:a.has("allow-spoiler"),onChange:(x,h)=>{h?a.set("allow-spoiler","true"):a.delete("allow-spoiler"),a.sort(),d(a,{replace:!0})}}),label:I(ue,{children:[c(q,{children:"Allow spoiler"}),c(q,{sx:{color:"text.secondary",fontSize:"smaller"},children:"Allow model reactions that has not yet appeared in the game."})]})})})})]}),c(j,{variant:"contained",fullWidth:!0,disabled:m,onClick:()=>t(n,{state:{modal:"confirm"},replace:!0}),children:"Generate Model"})]}),c(on,{}),c(rn,{}),c(sn,{}),c(We,{open:(e==null?void 0:e.snackbar)!==void 0,autoHideDuration:6e3,children:c(Ge,{severity:(p=e==null?void 0:e.snackbar)==null?void 0:p.severity,children:(u=e==null?void 0:e.snackbar)==null?void 0:u.message})})]})}function cn(){var r;const{modelId:n}=pe();if(n===void 0||!/^\d+/.test(n))throw new Error("invalid modelId");const e=+n,[t]=k(),[o,{loading:i}]=Me(t,e);return c(O,{children:I(H,{children:["details:",(r=o==null?void 0:o.charaName)!=null?r:i?"Loading...":"Unknown"]})})}const ln=N(void 0);function Pe(){return L(ln)}function dn(n){const{title:e,children:t}=n,i=B().pathname.replace(/(?<!^)\/.*/,""),[r,{request:s}]=k(),[a]=Pe();return I(_,{sx:{height:"100vh"},children:[c(un,{direction:"down",children:c(V,{children:I(b,{children:[c(_,{sx:{flex:1},children:e}),r===void 0&&c(j,{variant:"contained",startIcon:c(fe,{}),onClick:s,children:"specify resource directory"})]})})}),c(b,{}),t,c(Ke,{sx:{position:"fixed",bottom:0,left:0,right:0},elevation:3,square:!0,children:I(Ve,{showLabels:!0,value:i,sx:{background:"transparent"},children:[c(he,{component:z,to:"/model",value:"/model",label:"Models",icon:c(Xe,{})}),c(he,{component:z,to:{pathname:"/bake",search:`${a!=null?a:""}`},value:"/bake",label:"Generate EX Model",icon:c(Qe,{})})]})})]})}function un(n){const{children:e,direction:t}=n,o=le();return c(de,{appear:!1,direction:t,in:!o,children:e})}function fn(){const[n]=k(),[e]=K(n);return c(dn,{title:"Models",children:c(O,{children:y.exports.useMemo(()=>e==null?void 0:e.map(t=>c(X,{component:z,to:`${t}`,children:c(A,{modelId:t})},t)),[e])})})}function mn(){const n=pe();return c(O,{children:I(H,{children:["details ",JSON.stringify(n)]})})}function pn(){const[n]=k(),[e]=se(n);return c(ie,{title:"Scenario",children:c(re,{modelIds:e!=null?e:[],linkTo:t=>`${t}`})})}function hn(){const[n]=Pe();return I(it,{children:[c(D,{path:"/model",element:c(fn,{})}),c(D,{path:"/model/:modelId",element:c(cn,{})}),c(D,{path:"/scenario",element:c(pn,{})}),c(D,{path:"/scenario/:scenarioId",element:c(mn,{})}),c(D,{path:"/bake",element:c(an,{})}),c(D,{path:"*",element:c(rt,{to:`/bake${n===void 0?"":`?${n}`}`})})]})}function yn(){const n=Ze("(prefers-color-scheme: dark)"),e=y.exports.useMemo(()=>et({palette:{mode:n?"dark":"light"}}),[n]);return I(tt,{theme:e,children:[c(nt,{}),c(ot,{basename:"/mgrcd",children:c(hn,{})})]})}st.exports.render(c(y.exports.StrictMode,{children:c(yn,{})}),document.getElementById("root"));
