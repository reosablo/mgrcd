var Ne=Object.defineProperty,be=Object.defineProperties;var Fe=Object.getOwnPropertyDescriptors;var ce=Object.getOwnPropertySymbols;var De=Object.prototype.hasOwnProperty,Ce=Object.prototype.propertyIsEnumerable;var le=(n,e,t)=>e in n?Ne(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,M=(n,e)=>{for(var t in e||(e={}))De.call(e,t)&&le(n,t,e[t]);if(ce)for(var t of ce(e))Ce.call(e,t)&&le(n,t,e[t]);return n},$=(n,e)=>be(n,Fe(e));import{h as _e,a as D,r as y,u as B,b as q,j as v,B as N,c as a,A as X,T as C,I as Te,d as Ae,e as de,S as ue,f as Re,g as Le,i as Oe,k as Be,l as Ee,m as je,n as z,L as E,o as Q,p as J,q as _,s as j,F as fe,t as H,v as me,w as Z,x as W,C as pe,y as He,z as We,D as Ge,E as Ue,G as qe,H as ze,J as ee,K as Je,M as Ye,N as Ke,O as Ve,P as he,Q as Xe,R as Qe,U as ye,V as Ze,W as et,X as tt,Y as nt,Z as ot,_ as it,$ as rt,a0 as st,a1 as T,a2 as at,a3 as ct}from"./vendor.a63c22a0.js";const lt=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}};lt();const dt=["image_native","mini","image"];async function*ut(n){var t,o;const e=await dt.reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const s=(o=(t=i.match(/^mini_(?<id>\d{6})_d\.png$/))==null?void 0:t.groups)==null?void 0:o.id;s!==void 0&&r instanceof FileSystemFileHandle&&(yield[+s,r])}}async function ft(n){return JSON.parse(n)}function mt(n,e){return JSON.stringify(n,null,e)}async function pt(n){return _e.parse(n)}async function ht(n){return JSON.parse(n)}const yt=["image_native","live2d_v4"],gt="model.model3.json",xt="params.json";async function*It(n){var t,o;const e=await yt.reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const s=(o=(t=i.match(/^(?<id>\d{6})$/))==null?void 0:t.groups)==null?void 0:o.id;s!==void 0&&r instanceof FileSystemDirectoryHandle&&(yield[+s,r])}}async function vt(n){return await n.getFileHandle(gt)}async function ge(n){return await n.getFileHandle(xt)}async function St(n,e){return await n.getFileHandle(`model-${e}.model3.json`,{create:!0}).then(t=>t.createWritable())}async function Mt(n){return await n.getFile().then(e=>e.text()).then(e=>ft(e))}async function wt(n,e){const t=mt(e,"	");await n.write(t)}async function xe(n){return await n.getFile().then(e=>e.text()).then(e=>pt(e))}const Pt=["scenario","json","general"],kt=["scenario","json","charaOneShot"];async function*$t(n){var t,o;const e=await Pt.reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const s=(o=(t=i.match(/^(?<id>\d{6})\.json$/))==null?void 0:t.groups)==null?void 0:o.id;s!==void 0&&r instanceof FileSystemFileHandle&&(yield[+s,r])}}async function*Nt(n){var t,o;const e=await kt.reduce(async(i,r)=>(await i).getDirectoryHandle(r),Promise.resolve(n));for await(const[i,r]of e.entries()){const s=(o=(t=i.match(/^(?<id>\d{6})\.json$/))==null?void 0:t.groups)==null?void 0:o.id;s!==void 0&&r instanceof FileSystemFileHandle&&(yield[+s,r])}}async function Ie(n){return await n.getFile().then(e=>e.text()).then(e=>ht(e))}function bt(n,e,t,o,{enableMute:i,filterRoleId:r}){var s,c;for(const[d,l]of e.entries()){const u=o.getMotionIndex("scene",t,d),[g,x]=u,f=d+1<e.length?o.getMotionIndex("scene",t,d+1).join(":"):void 0,p=l.autoTurnFirst!==void 0?l.autoTurnFirst*1e3:l.autoTurnLast!==void 0?l.autoTurnLast*1e3:void 0,h=(c=(s=l.chara)==null?void 0:s.filter(w=>r(w.id)))!=null?c:[],m=At(h,o,{enableMute:i}),I=Rt(h);Tt(n,h,o),A(n,g,{Name:x,MotionDuration:p,Command:m,Text:I,NextMtn:f})}}function Y([n,e]){return e!==void 0?`${n}:${e}`:n}function te(n,[e,t]){var o,i;return t!==void 0&&!!((i=(o=n.FileReferences.Motions)==null?void 0:o[e])==null?void 0:i.some(r=>r.Name===t))}function Ft(n,e){var t;return!!((t=n.FileReferences.Expressions)==null?void 0:t.some(o=>o.Name===e))}function A(n,e,t){var r,s,c,d;const o=(d=(c=(s=(r=n.FileReferences).Motions)!=null?s:r.Motions={})[e])!=null?d:c[e]=[],i=t.Name;if(i===void 0)o.push(t);else{const l=o.findIndex(u=>u.Name===i);l>=0?o.splice(l,1,t):o.push(t)}}function Dt(n,e){var r,s;const t=(s=(r=n.FileReferences).Expressions)!=null?s:r.Expressions=[],o=e.Name,i=t.findIndex(c=>c.Name!==o);i>=0?t.splice(i,1,e):t.push(e)}function Ct(n,e){var o;const t=(o=n.Options)!=null?o:n.Options={};t.Name=e.charaName,t.ScaleFactor=e.modelScale}function _t(n,e,{otherRoleIds:t}){const o=Y(n),i=[`start_mtn ${o}`];for(const r of t)i.push(`start_mtn ${e.getModelId(r)} ${o}`);return i.join(";")}function Tt(n,e,t){for(const o of e){const{motion:i,face:r,voice:s}=o;if(i!==void 0){const c=t.getMotionIndex("motion",i);if(!te(n,c)){const[d,l]=c,u=t.getFilePath("motion",i);i<100?A(n,d,{Name:l,File:u,FileLoop:!0,Command:"eye_blink enforce",FadeOut:0}):A(n,d,{Name:l,Command:"eye_blink enforce",File:u})}}if(r!==void 0){const c=t.getMotionIndex("face",r),d=t.getExpressionName("face",r);if(!te(n,c)){const[l,u]=c;A(n,l,{Name:u,Expression:d})}if(!Ft(n,d)){const l=t.getFilePath("face",r);Dt(n,{Name:d,File:l})}}if(s!==void 0){const c=t.getMotionIndex("voice",s);if(!te(n,c)){const[d,l]=c,u=t.getFilePath("voice",s);A(n,d,{Name:l,Sound:u})}}}}function At(n,e,{enableMute:t}){var i;const o=[];for(const r of n){const{motion:s,face:c,voice:d,lipSynch:l,cheek:u,eyeClose:g,mouthOpen:x,soulGem:f,tear:p,live2dParam:h,textHomeStatus:m}=r;if(s!==void 0){const I=e.getMotionIndex("motion",s);o.push(`start_mtn ${Y(I)}`)}if(c!==void 0){const I=e.getMotionIndex("face",c);o.push(`start_mtn ${Y(I)}`)}if(d!==void 0){const I=e.getMotionIndex("voice",d);o.push(`start_mtn ${Y(I)}`)}if(l!==void 0&&(l?t?o.push("unmute_sound 0"):(o.push("lip_sync enable"),x===void 0&&o.push("parameters unlock ParamMouthOpenY")):t?o.push("mute_sound 0"):(o.push("lip_sync disable"),x===void 0&&o.push("parameters lock ParamMouthOpenY 0"))),u!==void 0&&o.push(`parameters lock ParamCheek ${u}`),g!==void 0&&(g===0?o.push("parameters unlock ParamEyeLOpen","parameters unlock ParamEyeROpen"):o.push(`parameters lock ParamEyeLOpen ${1-g}`,`parameters lock ParamEyeROpen ${1-g}`)),x!==void 0&&(x===0?o.push("parameters unlock ParamMouthOpenY"):o.push(`parameters lock ParamMouthOpenY ${x}`)),f!==void 0&&(f===1?o.push("parameters unlock ParamSoulgem"):o.push(`parameters lock ParamSoulgem ${f}`)),p!==void 0&&(p===0?o.push("parameters unlock ParamTear"):o.push(`parameters lock ParamTear ${p}`)),(h==null?void 0:h.name)!==void 0){const I=h.name.replace(/_?([A-Za-z]+)/g,(w,P)=>`${P[0].toUpperCase()}${P.slice(1).toLowerCase()}`);o.push(`parameters lock ${I} ${(i=h.value)!=null?i:0}`)}m==="Clear"&&o.push("hide_text")}return o.join(";")||void 0}function Rt(n){const e=[];for(const t of n){const{textHome:o}=t;if(o!==void 0){const i=o.replace(/\[.*?\]/g,"").replace(/@/g,`
`);e.push(i)}}return e.join("{$br}")||void 0}const S=Symbol("metaKey"),ve=[["Start",{Name:"Intro1",Priority:9,Intimacy:{Max:0},[S]:{voiceSuffix:"_01",spoiler:!1}}],["Start",{Name:"Intro2",Priority:9,Intimacy:{Max:0},[S]:{voiceSuffix:"_02",spoiler:!1}}],["Start",{Name:"GreetFirst",Priority:9,Intimacy:{Min:1,Bonus:4},[S]:{voiceSuffix:"_24",spoiler:!1}}],["Tap",{Name:"Talk1",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_33",spoiler:!1}}],["Tap",{Name:"Talk2",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_34",spoiler:!1}}],["Tap",{Name:"Talk3",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_35",spoiler:!1}}],["Tap",{Name:"Talk4",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_36",spoiler:!1}}],["Tap",{Name:"Talk5",Priority:9,Intimacy:{Min:8,Bonus:1},[S]:{voiceSuffix:"_37",spoiler:!1}}],["Tap",{Name:"Talk6",Priority:9,Intimacy:{Min:16,Bonus:1},[S]:{voiceSuffix:"_38",spoiler:!1}}],["Tap",{Name:"Talk7",Priority:9,Intimacy:{Min:24,Bonus:1},[S]:{voiceSuffix:"_39",spoiler:!1}}],["Tap",{Name:"Talk8",Priority:9,Intimacy:{Min:32,Bonus:1},[S]:{voiceSuffix:"_40",spoiler:!1}}],["Tap",{Name:"Talk9",Priority:9,Intimacy:{Min:40,Bonus:1},[S]:{voiceSuffix:"_41",spoiler:!1}}],["Tap",{Name:"Talk10",Priority:9,Intimacy:{Min:48,Bonus:1},[S]:{voiceSuffix:"_32",spoiler:!0}}],["Tap",{Name:"GreetMorning",Priority:9,Weight:2,TimeLimit:{Hour:6,Sustain:180},Intimacy:{Bonus:1},[S]:{voiceSuffix:"_25",spoiler:!1}}],["Tap",{Name:"GreetDay",Priority:9,Weight:2,TimeLimit:{Hour:11,Sustain:120},Intimacy:{Bonus:1},[S]:{voiceSuffix:"_26",spoiler:!1}}],["Tap",{Name:"GreetEvening",Priority:9,Weight:2,TimeLimit:{Hour:17,Sustain:120},Intimacy:{Bonus:1},[S]:{voiceSuffix:"_27",spoiler:!1}}],["Tap",{Name:"GreetNight",Priority:9,Weight:2,TimeLimit:{Hour:22,Sustain:120},Intimacy:{Bonus:1},[S]:{voiceSuffix:"_28",spoiler:!1}}],["Tap",{Name:"Greet",Priority:9,ignorable:!0,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_29",spoiler:!1}}],["Tap",{Name:"GreetAP",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_30",spoiler:!1}}],["Tap",{Name:"GreetBP",Priority:9,Intimacy:{Bonus:1},[S]:{voiceSuffix:"_31",spoiler:!1}}]];class Lt{getRoleId(...e){const[t]=e;return t||void 0}getModelId(...e){const[t]=e;return`${t}`}getMotionIndex(...e){switch(e[0]){case"scene":{const[,t,o]=e;return["Story#1",`${t}_${o+1}`]}case"motion":{const[,t]=e;return["Motion#2",`${t}`]}case"voice":{const[,t]=e;return["Voice#3",t]}case"voiceFull":{const[,t]=e;return["VoiceFull#3",t]}case"face":{const[,t]=e,o=Se(t);return["Face#4",o!==void 0?`${o}`:t]}}}getExpressionName(...e){switch(e[0]){case"face":{const[t,o]=e;return Me(o)}}}getFilePath(...e){switch(e[0]){case"motion":{const[,t]=e;return`mtn/motion_${t.toString().padStart(3,"0")}.motion3.json`}case"face":{const[,t]=e;return`exp/${Me(t)}`}case"voice":{const[,t]=e;return`../../../sound_native/voice/${t}_hca.mp3`}case"voiceFull":{const[,t]=e;return`../../../sound_native/${t}_hca.mp3`}}}}function Se(n){var o;const e=/^mtn_ex_(?<face>\d{1,})\.exp3?\.json$/,t=(o=n.match(e))==null?void 0:o.groups.face;return t!==void 0?+t:void 0}function Me(n){const e=Se(n);return e!==void 0?`mtn_ex_${`${e}`.padStart(3,"0")}.exp3.json`:n}const Ot=ve.filter(([,n])=>!n[S].spoiler),Bt={allowSpoiler:!1,enableMute:!1,filterRoleId:n=>n!==void 0,otherRoleIds:[]};function Et(n,e,t){const{allowSpoiler:o,enableMute:i,filterRoleId:r,otherRoleIds:s}=M(M({},Bt),t),c=e.story;if(c===void 0)return;const d=o?ve:Ot,l=new Lt;for(const[u,g]of d){const{voiceSuffix:x}=g[S],f=Object.entries(c).find(([,w])=>{var P,G;return(G=(P=w[0])==null?void 0:P.chara)==null?void 0:G.some(O=>{var b;return(b=O.voice)==null?void 0:b.endsWith(x)})});if(f===void 0)continue;const[p,h]=f,m=l.getMotionIndex("scene",p,0),I=$(M({},g),{Command:_t(m,l,{otherRoleIds:s})});A(n,u,I),bt(n,h,p,l,{enableMute:i,filterRoleId:r})}}function jt(n,e){var r,s,c;const t=(r=n.Controllers)!=null?r:n.Controllers={},o=(s=n.Options)!=null?s:n.Options={},i=Object.values((c=n.FileReferences.Motions)!=null?c:{}).flat().reduce((d,l)=>{var u;return((u=l.Intimacy)==null?void 0:u.Min)?Math.max(d!=null?d:0,l.Intimacy.Min):d},void 0);t.IntimacySystem={Enabled:!0,MaxValue:i},o.Id=`${e}`,o.AnisoLevel=2}const Ht=D(()=>new WeakMap),ne=D({},()=>{throw new Error("invalid operation: source is undefined")});function R(n,e){const t=B(Ht)[0],o=e===void 0?ne:(()=>{var p,h;const x=(p=t.get(n))!=null?p:(()=>{const m=new WeakMap;return t.set(n,m),m})();return(h=x.get(e))!=null?h:(()=>{const m=D({});return x.set(e,m),m})()})(),i=y.exports.useMemo(()=>e===void 0?ne:D(void 0,async(x,f)=>{const p=x(o).loading;if(p!==void 0)try{await p}catch{return}else{const h=n(e);f(o,m=>$(M({},m),{loading:h}));try{f(o,{data:await h})}catch(m){f(o,I=>({data:I.data,error:m}))}}}),[n,o,e]),r=y.exports.useMemo(()=>e===void 0?ne:D(void 0,async(x,f)=>{const p=x(o);"data"in p||"error"in p||await f(i)}),[o,i,e]),s=B(o)[0],{data:c,loading:d}=s,l=B(r)[1],u=B(i)[1],g=y.exports.useMemo(()=>$(M(M({},"error"in s?{error:s.error}:{}),e!==void 0?{load:l,reload:u}:{}),{loading:!!d}),[s,e,l,u,d]);return y.exports.useEffect(()=>{e!==void 0&&l()},[l,e]),y.exports.useMemo(()=>[c,g],[c,g])}function oe(n,e){const[t,o]=y.exports.useState({}),{data:i,loading:r}=t,s=y.exports.useRef(t.loading),c=y.exports.useCallback(async()=>{if(e===void 0)throw new Error("invalid operation: source is undefined");if(s.current!==void 0)try{await s.current}catch{return}else{const g=n(e);s.current=g,o(x=>$(M({},x),{loading:g}));try{o({data:await g})}catch(x){o(f=>({data:f.data,error:x}))}finally{s.current=void 0}}},[n,e]),d=y.exports.useCallback(async()=>{"data"in t||"error"in t||await c()},[t,c]),l=y.exports.useCallback(()=>{o(({loading:g})=>({loading:g}))},[]),u=y.exports.useMemo(()=>$(M(M({},"error"in t?{error:t.error}:{}),e!==void 0?{load:d,reload:c}:{}),{loading:!!r}),[t,e,d,c,r]);return y.exports.useEffect(()=>{e!==void 0?c():l()},[c,e,l]),y.exports.useMemo(()=>[i,u],[i,u])}async function Wt(n){const e={};for await(const[t,o]of It(n))e[t]=o;return e}function ie(n){return R(Wt,n)}function re(n){const{title:e,children:t}=n,o=q();return v(N,{children:[a(Gt,{direction:"down",children:a(X,{children:v(C,{sx:{gap:"1em"},children:[a(Te,{onClick:()=>o(-1),children:a(Ae,{})}),a(N,{sx:{flex:1},children:e})]})})}),a(C,{}),t]})}function Gt(n){const{children:e,direction:t}=n,o=de();return a(ue,{appear:!1,direction:t,in:!o,children:e})}async function Ut(n){const e={};for await(const[t,o]of ut(n))e[t]=o;return e}function qt(n){return R(Ut,n)}const zt=new FinalizationRegistry(n=>URL.revokeObjectURL(n));async function Jt(n){const e=await n.getFile(),t=URL.createObjectURL(e);return zt.register(n,t),await new Promise((o,i)=>{const r=new Image;r.onload=()=>o(),r.onerror=s=>i(s),r.src=t}),t}function Yt(n,e){const[t]=qt(n),o=e!==void 0?t==null?void 0:t[e]:void 0;return R(Jt,o)}async function Kt(n){const e=await ge(n);return await xe(e)}function we(n,e){const[t,{error:o}]=ie(n),i=e!==void 0?t==null?void 0:t[e]:void 0,[r,s]=R(Kt,i),{error:c}=s,d=y.exports.useMemo(()=>$(M({},s),{error:o!=null?o:c}),[s,c,o]);return y.exports.useMemo(()=>[r,d],[d,r])}const K=Re(void 0),Vt=D(void 0,async(n,e)=>{try{const t=await showDirectoryPicker();e(K,t)}catch(t){if(t instanceof Error&&t.name==="AbortError")return;throw e(K,void 0),t}});function k(){const n=Le(K),e=Oe(Vt),t=Be(K),o=y.exports.useMemo(()=>({request:e,invalidate:t}),[t,e]);return y.exports.useMemo(()=>[n,o],[o,n])}function L(n){var f;const{modelId:e,sx:t,alt:o}=n,i=o!=null?o:`ID: ${e}`,[r,s]=Ee({triggerOnce:!0}),[c]=k(),d=s?e:void 0,[l,{loading:u}]=we(c,d),g=s&&e!==void 0?e-e%100:void 0,[x]=Yt(c,g);return v(N,{sx:M({display:"inline-flex",gap:"1em",alignItems:"center",textAlign:"start"},t),ref:r,children:[a(je,{src:x}),v(N,{sx:{flex:"1"},children:[a(z,{children:(f=l==null?void 0:l.charaName)!=null?f:i}),a(z,{sx:{color:"text.secondary",fontSize:"smaller"},children:(l==null?void 0:l.charaName)?i:u?"Loading...":"Unknown"})]})]})}function se(n){const{modelIds:e,selectedModelId:t}=n,o="linkTo"in n?n.linkTo:void 0,i="onSelect"in n?n.onSelect:void 0;return a(E,{children:y.exports.useMemo(()=>e.map(r=>{const s=t===r;return a(Q,$(M({selected:s,ref:c=>{s&&(c==null||c.scrollIntoView({block:"center"}))},onClick:()=>i==null?void 0:i(r)},o!==void 0&&{component:J,to:o(r)}),{children:a(L,{modelId:r,sx:{flex:1}})}),r)}),[o,i,e,t])})}function V(n){const[e,t]=ie(n),o=y.exports.useMemo(()=>e!==void 0?Object.keys(e).map(i=>+i):void 0,[e]);return y.exports.useMemo(()=>[o,t],[t,o])}async function Xt(n){const e={};for await(const[t,o]of Nt(n))e[t]=o;return e}function Qt(n){return R(Xt,n)}function Zt(n,e){const[t]=Qt(n),o=e!==void 0?t==null?void 0:t[e]:void 0;return oe(Ie,o)}async function*en(n){var t,o;const e=new Set;for(const i of Object.values((t=n.story)!=null?t:{}))for(const r of i)for(const s of(o=r.chara)!=null?o:[]){const c=s.id;e.has(c)||(yield c,e.add(c))}}async function tn(n){const e=[];for await(const t of en(n))t===void 0||t===0||e.push(t);return e.sort((t,o)=>t-o),e}function nn(n,e){const[t]=Zt(n,e),[o,i]=oe(tn,t),r=y.exports.useMemo(()=>o!=null?o:e!==void 0?[e]:[],[o,e]);return y.exports.useMemo(()=>[r,i],[i,r])}async function on(n){const e={};for await(const[t,o]of $t(n))e[t]=o;return e}function Pe(n){return R(on,n)}function rn(n,e){const[t]=Pe(n),o=e!==void 0?t==null?void 0:t[e]:void 0;return oe(Ie,o)}function ae(n){const[e,t]=Pe(n),o=y.exports.useMemo(()=>e!==void 0?Object.keys(e).filter(i=>/^\d+$/.test(i)).map(i=>+i):void 0,[e]);return y.exports.useMemo(()=>[o,t],[o,t])}function sn(n){const e=_(),t=q(),{scenarioId:o}=n,[i]=k(),[r]=V(i),[s,{loading:c}]=nn(i,o),[d,l]=j(),u=y.exports.useMemo(()=>new Map(d.getAll("cast").map(f=>{var I;const p=f.match(/^(?<roleId>\d+):(?<modelId>\d+)$/),{roleId:h,modelId:m}=(I=p==null?void 0:p.groups)!=null?I:{};return p!==null?[+h,+m]:void 0}).filter(f=>f)),[d]);y.exports.useEffect(()=>{if(s!==void 0){const f=d.getAll("cast"),p=f.filter(h=>s.includes(+h.split(/:/)[0]));if(p.length!==f.length){d.delete("cast");for(const h of p)d.append("cast",h);d.sort(),l(d,{replace:!0})}else if(p.length<s.length&&o!==void 0&&r!==void 0){const h=s.filter(m=>!p.some(I=>I.startsWith(`${m}:`)));for(const m of h){const I=m-m%100;r.includes(m)?d.append("cast",`${m}:${m}`):r.includes(I)&&d.append("cast",`${m}:${I}`)}l(d,{replace:!0})}}},[r,s,o,d,l]);const g=y.exports.useMemo(()=>[{field:"role",headerName:"Role",sortable:!1,flex:1,renderCell(f){const p=f.value;return a(L,{modelId:p,alt:`Role ID: ${p}`})}},{field:"actor",headerName:"Actor Model",sortable:!1,flex:1,renderCell(f){const p=f.value;return v(H,{sx:{display:"flex",width:"100%",height:"100%",alignItems:"center",textDecoration:"none",textTransform:"none",color:"text.primary"},onClick:()=>t(e,{state:{modal:"select-model",roleId:f.row.role}}),children:[a(L,{modelId:p,sx:{flex:1},alt:`Model ID: ${p}`}),a(pe,{})]})}}],[e,t]),x=y.exports.useMemo(()=>{var f;return(f=s==null?void 0:s.map(p=>({id:p,role:p,actor:u.get(p)})))!=null?f:[]},[u,s]);return a(ze,{columns:g,rows:x,autoHeight:!0,disableColumnFilter:!0,disableColumnSelector:!0,hideFooter:!0,loading:c})}function an(){var d;const e=_().state,[t,o]=j(),[i]=k(),[r]=ae(i),s=+((d=t.get("scenario"))!=null?d:NaN),c=y.exports.useCallback(l=>{t.set("scenario",`${l}`),t.sort(),o(t,{replace:!0})},[t,o]);return a(ee,{fullScreen:!0,open:(e==null?void 0:e.modal)==="select-scenario",children:a(re,{title:"select Scenario",children:a(se,{modelIds:r!=null?r:[],onSelect:c,selectedModelId:s})})})}function cn(){var l,u;const e=_().state,[t,o]=j(),[i]=k(),[r]=V(i),s=e==null?void 0:e.roleId,c=+((u=(l=t.getAll("cast").find(g=>g.startsWith(`${s}:`)))==null?void 0:l.replace(`${s}:`,""))!=null?u:NaN),d=y.exports.useCallback(g=>{if(c===void 0)t.append("cast",`${s}:${g}`);else{const x=t.getAll("cast").map(f=>f.startsWith(`${s}:`)?`${s}:${g}`:f);t.delete("cast");for(const f of x)t.append("cast",f)}t.sort(),o(t,{replace:!0})},[t,c,s,o]);return a(ee,{fullScreen:!0,open:(e==null?void 0:e.modal)==="select-model",children:a(re,{title:v(N,{sx:{display:"inline-flex",alignItems:"center",gap:"1em"},children:["select Model for Role",a(L,{modelId:s})]}),children:a(se,{modelIds:r!=null?r:[],onSelect:d,selectedModelId:c})})})}function ln(){const[n]=k(),[e]=ie(n),t=_(),o=t.state,i=q(),[r]=j(),[s,c]=y.exports.useState(!1),d=r.get("allow-spoiler")!==null,l=(h=>h!==null?+h:void 0)(r.get("scenario")),[u]=rn(n,l),g=y.exports.useMemo(()=>r.getAll("cast").map(h=>{var P;const m=h.match(/^(?<roleId>\d+):(?<modelId>\d+)$/),{roleId:I,modelId:w}=(P=m==null?void 0:m.groups)!=null?P:{};return m!==null?[+I,+w]:void 0}).filter(h=>h),[r]),x=y.exports.useCallback(([h,m])=>`image_native/live2d_v4/${m}/model-${g.length===1?`${l}`:`${l}@${h}`}.json`,[g.length,l]),f=y.exports.useMemo(()=>g.map(x),[g,x]),p=y.exports.useCallback(()=>{if(l===void 0||u===void 0)throw new Error("scenario is undefined");c(!0);const h=g.map(([m])=>m);Promise.all(g.map(async([m,I])=>{const w=e==null?void 0:e[I];if(w===void 0)throw new Error("modelDirectory is undefined");const P=m-m%100,G=h.includes(P)?[m]:[m,P],O=new Set(h);O.delete(m);const[b,$e]=await Promise.all([vt(w).then(F=>Mt(F)),ge(w).then(F=>xe(F))]);Et(b,u,{allowSpoiler:d,enableMute:O.size>0,filterRoleId:F=>G.includes(F),otherRoleIds:O}),Ct(b,$e),jt(b,m);const U=await St(w,g.length===1?`${l}`:`${l}@${m}`);try{await U.truncate(0),await wt(U,b),await U.close()}catch(F){throw await U.abort(),F}})).then(()=>({severity:"success",message:"succeeded to generate models"}),m=>({severity:"error",error:`${m.message}`})).then(m=>i(t,{state:{snackbar:m}})).finally(()=>c(!1))},[d,g,t,e,i,u,l]);return v(ee,{open:(o==null?void 0:o.modal)==="confirm",onClose:()=>i(t,{replace:!0}),children:[v(Je,{children:[v(Ye,{children:["The following",f.length>1?" files ":" file ","will be created on your disk."]}),a("ul",{children:f.map(h=>a("li",{children:h},h))})]}),v(Ke,{children:[a(H,{onClick:()=>i(t,{replace:!0}),children:"Cancel"}),v(Ve,{variant:"contained",loading:s,onClick:p,children:["Create ",f.length>1?" those files ":" this file "]})]})]})}function dn(){var x,f;const n=_(),e=n.state,t=q(),[o,{request:i}]=k(),[r]=V(o),[s]=ae(o),[c,d]=j(),l=c.get("scenario");l!==null&&!/^\d+$/.test(l)&&t($(M({},n),{search:""}));const u=l!==null?+l:void 0,g=o===void 0||u===void 0;return y.exports.useEffect(()=>{u===void 0&&r!==void 0&&r.length>0&&(c.set("scenario",`${r[0]}`),d(c))},[r,u,c,d]),y.exports.useEffect(()=>{if(u!==void 0&&s!==void 0&&!s.includes(u)){const p=u-u%100;s.includes(p)?(c.set("scenario",`${p}`),d(c)):(c.delete("scenario"),d(c))}},[u,s,c,d]),v(fe,{children:[v(N,{children:[a(X,{children:v(C,{children:[a(N,{sx:{flex:1},children:"Generate EX Model"}),o===void 0&&a(H,{variant:"contained",startIcon:a(me,{}),onClick:i,children:"specify resource directory"})]})}),a(C,{}),v(E,{children:[a(Z,{children:"Scenario"}),a(W,{disablePadding:!0,children:v(Q,{onClick:()=>o!==void 0?t(n,{state:{modal:"select-scenario"}}):i(),children:[a(L,{modelId:u,alt:`Scenario ID: ${u}`,sx:{flex:1}}),a(pe,{})]})}),a(Z,{children:"Cast"}),a(W,{disablePadding:!0,children:a(sn,{scenarioId:u})}),a(Z,{children:"Option"}),a(W,{children:a(He,{children:a(We,{control:a(Ge,{checked:c.has("allow-spoiler"),onChange:(p,h)=>{h?c.set("allow-spoiler","true"):c.delete("allow-spoiler"),c.sort(),d(c,{replace:!0})}}),label:v(fe,{children:[a(z,{children:"Allow spoiler"}),a(z,{sx:{color:"text.secondary",fontSize:"smaller"},children:"Allow model reactions that has not yet appeared in the game."})]})})})})]}),a(H,{variant:"contained",fullWidth:!0,disabled:g,onClick:()=>t(n,{state:{modal:"confirm"},replace:!0}),children:"Generate Model"})]}),a(an,{}),a(cn,{}),a(ln,{}),a(Ue,{open:(e==null?void 0:e.snackbar)!==void 0,autoHideDuration:6e3,children:a(qe,{severity:(x=e==null?void 0:e.snackbar)==null?void 0:x.severity,children:(f=e==null?void 0:e.snackbar)==null?void 0:f.message})})]})}function un(){var r;const{modelId:n}=he();if(n===void 0||!/^\d+/.test(n))throw new Error("invalid modelId");const e=+n,[t]=k(),[o,{loading:i}]=we(t,e);return a(E,{children:v(W,{children:["details:",(r=o==null?void 0:o.charaName)!=null?r:i?"Loading...":"Unknown"]})})}const fn=D(void 0);function ke(){return B(fn)}function mn(n){const{title:e,children:t}=n,i=_().pathname.replace(/(?<!^)\/.*/,""),[r,{request:s}]=k(),[c]=ke();return v(N,{sx:{height:"100vh"},children:[a(pn,{direction:"down",children:a(X,{children:v(C,{children:[a(N,{sx:{flex:1},children:e}),r===void 0&&a(H,{variant:"contained",startIcon:a(me,{}),onClick:s,children:"specify resource directory"})]})})}),a(C,{}),t,a(Xe,{sx:{position:"fixed",bottom:0,left:0,right:0},elevation:3,square:!0,children:v(Qe,{showLabels:!0,value:i,sx:{background:"transparent"},children:[a(ye,{component:J,to:"/model",value:"/model",label:"Models",icon:a(Ze,{})}),a(ye,{component:J,to:{pathname:"/bake",search:`${c!=null?c:""}`},value:"/bake",label:"Generate EX Model",icon:a(et,{})})]})})]})}function pn(n){const{children:e,direction:t}=n,o=de();return a(ue,{appear:!1,direction:t,in:!o,children:e})}function hn(){const[n]=k(),[e]=V(n);return a(mn,{title:"Models",children:a(E,{children:y.exports.useMemo(()=>e==null?void 0:e.map(t=>a(Q,{component:J,to:`${t}`,children:a(L,{modelId:t})},t)),[e])})})}function yn(){const n=he();return a(E,{children:v(W,{children:["details ",JSON.stringify(n)]})})}function gn(){const[n]=k(),[e]=ae(n);return a(re,{title:"Scenario",children:a(se,{modelIds:e!=null?e:[],linkTo:t=>`${t}`})})}function xn(){const[n]=ke();return v(st,{children:[a(T,{path:"/model",element:a(hn,{})}),a(T,{path:"/model/:modelId",element:a(un,{})}),a(T,{path:"/scenario",element:a(gn,{})}),a(T,{path:"/scenario/:scenarioId",element:a(yn,{})}),a(T,{path:"/bake",element:a(dn,{})}),a(T,{path:"*",element:a(at,{to:`/bake${n===void 0?"":`?${n}`}`})})]})}function In(){const n=tt("(prefers-color-scheme: dark)"),e=y.exports.useMemo(()=>nt({palette:{mode:n?"dark":"light"}}),[n]);return v(ot,{theme:e,children:[a(it,{}),a(rt,{basename:"/mgrcd",children:a(xn,{})})]})}ct.exports.render(a(y.exports.StrictMode,{children:a(In,{})}),document.getElementById("root"));
